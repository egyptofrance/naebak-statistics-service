# 📊 LEADER - دليل خدمة الإحصائيات

**اسم الخدمة:** naebak-statistics-service  
**المنفذ:** 8012  
**الإطار:** Flask 2.3  
**قاعدة البيانات:** Redis 6.2 (للبيانات السريعة والعدادات)  
**التحليلات:** مخصصة مع NumPy و Pandas  

---

## 📋 **نظرة عامة على الخدمة**

### **🎯 الغرض الأساسي:**
خدمة الإحصائيات هي **المحرك التحليلي المركزي** لمنصة نائبك، مسؤولة عن جمع وتحليل وعرض جميع الإحصائيات والمقاييس الحيوية للمنصة في الوقت الفعلي.

### **📝 كيف يعمل التطبيق بالضبط:**

**جمع البيانات التلقائي:**
1. **كل خدمة مصغرة ترسل بياناتها** تلقائياً لخدمة الإحصائيات:
   - **خدمة المصادقة (8001):** عدد المستخدمين الجدد، تسجيلات الدخول
   - **خدمة الشكاوى (8003):** شكاوى جديدة، شكاوى محلولة، أوقات الاستجابة
   - **خدمة التقييمات (8005):** تقييمات جديدة، متوسطات التقييم
   - **خدمة عداد الزوار (8006):** زيارات الصفحات، أوقات التصفح
   - **خدمة الأخبار (8007):** مشاهدات الأخبار، تفاعل المستخدمين
   - **خدمة البنرات (8009):** مشاهدات ونقرات البنرات

2. **كل 5 دقائق** يتم تجميع البيانات وحساب:
   - **العدادات الإجمالية:** إجمالي المستخدمين، الشكاوى، التقييمات
   - **المتوسطات:** متوسط وقت الاستجابة، متوسط التقييمات
   - **التوزيعات:** حسب المحافظات، الأحزاب، الفئات

**عرض الإحصائيات:**
1. **لوحة التحكم الرئيسية** تعرض الأرقام الحية:
   - عدد المستخدمين النشطين الآن
   - عدد الشكاوى المعلقة
   - متوسط تقييم النواب
   - عدد الزوار اليوم

2. **صفحات الإحصائيات المفصلة** تعرض:
   - **إحصائيات المحافظات:** أكثر المحافظات نشاطاً
   - **إحصائيات النواب:** الأعلى تقييماً، الأسرع استجابة
   - **إحصائيات الشكاوى:** الفئات الأكثر شيوعاً

**مثال عملي:**
- مواطن يقدم شكوى → خدمة الشكاوى ترسل "+1 شكوى جديدة" → خدمة الإحصائيات تحدث العداد
- نائب يحل شكوى → خدمة الشكاوى ترسل "+1 شكوى محلولة" → خدمة الإحصائيات تحدث النسبة
- **النتيجة:** لوحة التحكم تعرض فوراً "1,247 شكوى إجمالي، 892 محلولة (71.5%)"

### **📊 الإحصائيات المُدارة:**
1. **إحصائيات المستخدمين:**
   - عدد المستخدمين المسجلين (إجمالي/نشط/جديد)
   - توزيع المستخدمين حسب المحافظات
   - إحصائيات تسجيل الدخول والنشاط

2. **إحصائيات النواب والأعضاء:**
   - عدد النواب المسجلين في المنصة
   - توزيع النواب حسب المحافظات والأحزاب
   - معدلات التفاعل والاستجابة

3. **إحصائيات الشكاوى:**
   - عدد الشكاوى (إجمالي/محلولة/معلقة)
   - توزيع الشكاوى حسب الفئات والمحافظات
   - أوقات الاستجابة ومعدلات الحل

4. **إحصائيات التفاعل:**
   - المشاهدات والزيارات
   - التقييمات والتعليقات
   - معدلات النقر والتفاعل

5. **إحصائيات النظام:**
   - أداء الخدمات المصغرة
   - استخدام الموارد
   - أوقات الاستجابة

### **🔧 الوظائف الرئيسية:**
1. **العدادات الفورية** - تتبع الأرقام في الوقت الفعلي
2. **تجميع البيانات** - تلخيص البيانات كل 5 دقائق
3. **تحليل الاتجاهات** - رصد التغيرات والأنماط
4. **المقاييس المخصصة** - إحصائيات خاصة بكل محافظة/حزب
5. **بيانات لوحة التحكم** - تغذية الواجهات الإدارية
6. **التقارير التلقائية** - تقارير يومية وأسبوعية وشهرية

---

## 🌐 **دور الخدمة في منصة نائبك**

### **🏛️ المكانة في النظام:**
خدمة الإحصائيات تعمل كـ **مركز البيانات التحليلية** الذي يجمع المعلومات من جميع الخدمات الأخرى ويحولها إلى رؤى قابلة للفهم والعمل.

### **📡 العلاقات مع الخدمات الأخرى:**

#### **🔗 الخدمات المرسلة للبيانات:**
- **خدمة المصادقة (8001)** - إحصائيات تسجيل الدخول والمستخدمين الجدد
- **خدمة الشكاوى (8003)** - بيانات الشكاوى والحلول
- **خدمة التقييمات (8004)** - تقييمات النواب والخدمات
- **خدمة الرسائل (8005)** - إحصائيات التواصل
- **خدمة الأخبار (8007)** - مشاهدات ومشاركات الأخبار
- **خدمة الإشعارات (8008)** - معدلات التسليم والقراءة
- **خدمة البنرات (8009)** - مشاهدات ونقرات البنرات
- **خدمة عداد الزوار (8011)** - بيانات الزيارات والجلسات

#### **🔗 الخدمات المستقبلة للبيانات:**
- **خدمة الإدارة (8002)** - لوحات تحكم إدارية
- **الواجهة الأمامية (3000)** - عرض الإحصائيات العامة
- **خدمة البوابة (8013)** - توجيه الطلبات حسب الأحمال

#### **🔄 تدفق البيانات:**
```
جميع الخدمات → Statistics Service (8012) → تحليل وتجميع
                        ↓
Admin Dashboard ← معالجة البيانات → Frontend Display
                        ↓
Gateway Service ← تحسين الأداء → Real-time Updates
```

#### **📊 أنماط التفاعل:**
1. **استقبال البيانات:** POST /api/statistics/record/
2. **تجميع دوري:** كل 5 دقائق تلقائياً
3. **عرض النتائج:** GET /api/statistics/overall/
4. **التحديث الفوري:** WebSocket للبيانات الحية

---

## 📦 **البيانات والنماذج من المستودع المخزن**

### **🏛️ المحافظات المصرية (27 محافظة):**
```python
GOVERNORATES = [
    {"name": "القاهرة", "name_en": "Cairo", "code": "CAI", "population": 10230350},
    {"name": "الجيزة", "name_en": "Giza", "code": "GIZ", "population": 8915071},
    {"name": "الإسكندرية", "name_en": "Alexandria", "code": "ALX", "population": 5484142},
    # ... باقي المحافظات الـ 27 مع بيانات السكان
]
```
**الاستخدام:** تجميع الإحصائيات حسب المحافظات وحساب النسب

### **🎭 الأحزاب السياسية (16 حزب):**
```python
POLITICAL_PARTIES = [
    {"name": "حزب مستقبل وطن", "abbreviation": "FN", "founded": 2014},
    {"name": "حزب الوفد", "abbreviation": "WP", "founded": 1919},
    {"name": "الحزب المصري الديمقراطي الاجتماعي", "abbreviation": "ESDP", "founded": 2011},
    # ... باقي الأحزاب الـ 16
]
```
**الاستخدام:** تحليل توزيع النواب والتفاعل حسب الانتماء الحزبي

### **🏛️ أنواع المجالس:**
```python
COUNCIL_TYPES = [
    {
        "type": "parliament",
        "name": "مجلس النواب",
        "name_en": "House of Representatives",
        "total_seats": 596,
        "term_years": 5
    },
    {
        "type": "senate", 
        "name": "مجلس الشيوخ",
        "name_en": "Senate",
        "total_seats": 300,
        "term_years": 5
    }
]
```

### **👥 أنواع المستخدمين:**
```python
USER_TYPES = [
    {"type": "citizen", "name": "مواطن", "permissions": ["view", "complain", "rate"]},
    {"type": "candidate", "name": "مرشح", "permissions": ["view", "respond", "campaign"]},
    {"type": "current_member", "name": "عضو حالي", "permissions": ["view", "respond", "official"]},
    {"type": "admin", "name": "إدارة", "permissions": ["all"]}
]
```

### **📋 فئات الشكاوى (11 فئة):**
```python
COMPLAINT_CATEGORIES = [
    {"category": "health", "name": "الصحة", "icon": "🏥", "priority": 1},
    {"category": "education", "name": "التعليم", "icon": "🎓", "priority": 2},
    {"category": "infrastructure", "name": "البنية التحتية", "icon": "🏗️", "priority": 3},
    {"category": "transportation", "name": "المواصلات", "icon": "🚌", "priority": 4},
    {"category": "utilities", "name": "المرافق", "icon": "💡", "priority": 5},
    {"category": "security", "name": "الأمن", "icon": "🛡️", "priority": 6},
    {"category": "environment", "name": "البيئة", "icon": "🌱", "priority": 7},
    {"category": "social_services", "name": "الخدمات الاجتماعية", "icon": "🤝", "priority": 8},
    {"category": "employment", "name": "التوظيف", "icon": "💼", "priority": 9},
    {"category": "housing", "name": "الإسكان", "icon": "🏠", "priority": 10},
    {"category": "other", "name": "أخرى", "icon": "📝", "priority": 11}
]
```

### **🔄 حالات الشكاوى:**
```python
COMPLAINT_STATUS = [
    {"status": "pending", "name": "معلقة", "color": "#FFC107"},
    {"status": "under_review", "name": "قيد المراجعة", "color": "#17A2B8"},
    {"status": "in_progress", "name": "قيد التنفيذ", "color": "#007BFF"},
    {"status": "resolved", "name": "محلولة", "color": "#28A745"},
    {"status": "closed", "name": "مغلقة", "color": "#6C757D"},
    {"status": "rejected", "name": "مرفوضة", "color": "#DC3545"}
]
```

---

## ⚙️ **إعدادات Google Cloud Run**

### **🛠️ بيئة التطوير (Development):**
```yaml
service_name: naebak-statistics-service-dev
image: gcr.io/naebak-472518/statistics-service:dev
cpu: 0.3
memory: 256Mi
min_instances: 0
max_instances: 3
concurrency: 100
timeout: 300s

environment_variables:
  - FLASK_ENV=development
  - DEBUG=true
  - LOG_LEVEL=DEBUG
  - REDIS_URL=redis://localhost:6379/12
  - STATS_RETENTION_DAYS=30
  - REAL_TIME_ENABLED=true
  - AGGREGATION_INTERVAL=60
  - ENABLE_DETAILED_LOGGING=true
```

### **🏭 إعدادات بيئة الإنتاج:**
```yaml
service_name: naebak-statistics-service
image: gcr.io/naebak-472518/statistics-service:latest
cpu: 0.3
memory: 256Mi
min_instances: 1
max_instances: 5
concurrency: 500
timeout: 60s

environment_variables:
  - FLASK_ENV=production
  - DEBUG=false
  - LOG_LEVEL=WARNING
  - REDIS_URL=${REDIS_URL}
  - STATS_RETENTION_DAYS=90
  - REAL_TIME_ENABLED=true
  - AGGREGATION_INTERVAL=300
  - ENABLE_DETAILED_LOGGING=false
```

### **🔧 إعدادات Redis:**
```yaml
# بيئة التطوير
REDIS_URL: redis://localhost:6379/12
REDIS_MAX_CONNECTIONS: 10
REDIS_SOCKET_TIMEOUT: 5

# بيئة الإنتاج  
REDIS_URL: redis://10.x.x.x:6379/12  # Cloud Memorystore
REDIS_MAX_CONNECTIONS: 50
REDIS_SOCKET_TIMEOUT: 3
REDIS_CONNECTION_POOL_SIZE: 20
```

---

## 🔐 **الأمان والصلاحيات**

### **🛡️ مستويات الوصول:**
1. **عام** - إحصائيات أساسية (عدد النواب، المحافظات)
2. **مستخدم مسجل** - إحصائيات شخصية (شكاواه، تقييماته)
3. **نائب** - إحصائيات دائرته ومحافظته
4. **مدير محافظة** - إحصائيات المحافظة كاملة
5. **مدير عام** - جميع الإحصائيات والتحليلات

### **🔒 آليات الحماية:**
- **JWT Authentication** للبيانات الحساسة
- **Rate Limiting** - 1000 طلب/ساعة للمستخدم العادي
- **Data Anonymization** - إخفاء البيانات الشخصية
- **Access Logging** - تسجيل جميع الوصولات
- **CORS Protection** - حماية من الطلبات الخارجية

---

## 📊 **المتغيرات والثوابت الأساسية**

### **🔢 إعدادات التجميع:**
```python
STATISTICS_SETTINGS = {
    'AGGREGATION_INTERVALS': {
        'real_time': 0,      # فوري
        'minute': 60,        # كل دقيقة
        'hourly': 3600,      # كل ساعة
        'daily': 86400,      # يومي
        'weekly': 604800,    # أسبوعي
        'monthly': 2592000   # شهري
    },
    'RETENTION_PERIODS': {
        'real_time': 24,     # 24 ساعة
        'hourly': 168,       # أسبوع
        'daily': 90,         # 3 شهور
        'weekly': 52,        # سنة
        'monthly': 24        # سنتان
    },
    'CACHE_DURATIONS': {
        'real_time': 30,     # 30 ثانية
        'summary': 300,      # 5 دقائق
        'daily': 3600,       # ساعة
        'reports': 86400     # يوم
    }
}
```

### **📈 أنواع المقاييس:**
```python
METRIC_TYPES = [
    {"type": "counter", "name": "عداد", "description": "قيم متزايدة فقط"},
    {"type": "gauge", "name": "مقياس", "description": "قيم متغيرة صعوداً وهبوطاً"},
    {"type": "histogram", "name": "توزيع", "description": "توزيع القيم"},
    {"type": "rate", "name": "معدل", "description": "معدل التغيير"},
    {"type": "percentage", "name": "نسبة مئوية", "description": "نسب من 0-100%"}
]
```

---

## 🔗 **واجهات برمجة التطبيقات (APIs)**

### **📡 نقاط النهاية الرئيسية:**
```
GET  /health                                    - فحص صحة الخدمة
GET  /api/statistics/overall/                   - الإحصائيات الإجمالية
GET  /api/statistics/users/                     - إحصائيات المستخدمين
GET  /api/statistics/complaints/                - إحصائيات الشكاوى
GET  /api/statistics/governorates/              - إحصائيات المحافظات
GET  /api/statistics/parties/                   - إحصائيات الأحزاب
GET  /api/statistics/trends/                    - تحليل الاتجاهات
GET  /api/statistics/real-time/                 - البيانات الفورية
POST /api/statistics/record/                    - تسجيل إحصائية جديدة
GET  /api/statistics/reports/daily              - التقرير اليومي
GET  /api/statistics/reports/weekly             - التقرير الأسبوعي
GET  /api/statistics/reports/monthly            - التقرير الشهري
```

### **📥 مثال تسجيل إحصائية:**
```json
POST /api/statistics/record/
Content-Type: application/json

{
  "metric_type": "counter",
  "metric_name": "user_login",
  "value": 1,
  "tags": {
    "governorate": "القاهرة",
    "user_type": "citizen",
    "platform": "web"
  },
  "timestamp": "2025-01-01T12:00:00Z"
}
```

### **📤 مثال استجابة الإحصائيات الإجمالية:**
```json
GET /api/statistics/overall/

{
  "status": "success",
  "data": {
    "users": {
      "total": 125000,
      "active_today": 8500,
      "new_this_month": 2300
    },
    "representatives": {
      "total": 896,
      "active": 742,
      "by_council": {
        "parliament": 596,
        "senate": 300
      }
    },
    "complaints": {
      "total": 45000,
      "resolved": 38000,
      "pending": 7000,
      "resolution_rate": 84.4
    },
    "engagement": {
      "total_visits": 2500000,
      "page_views": 8900000,
      "avg_session_duration": 420
    }
  },
  "last_updated": "2025-01-01T12:00:00Z"
}
```

---

## 🔄 **الفروق بين بيئات التشغيل**

### **🛠️ بيئة التطوير (Development):**
- **قاعدة البيانات:** Redis محلي (localhost:6379/12)
- **التجميع:** كل دقيقة (سريع للاختبار)
- **الاحتفاظ:** 30 يوم (توفير مساحة)
- **التسجيل:** مفصل (DEBUG level)
- **الحد الأدنى للخوادم:** 0 (توفير في التكلفة)
- **الموارد:** 0.3 CPU, 256Mi Memory

### **🏭 بيئة الإنتاج (Production):**
- **قاعدة البيانات:** Redis على Cloud Memorystore
- **التجميع:** كل 5 دقائق (محسن للأداء)
- **الاحتفاظ:** 90 يوم (تحليل طويل المدى)
- **التسجيل:** أخطاء فقط (WARNING level)
- **الحد الأدنى للخوادم:** 1 (ضمان التوفر)
- **الموارد:** 0.3 CPU, 256Mi Memory (محسن)

### **🧪 بيئة الاختبار (Testing):**
- **قاعدة البيانات:** Redis في الذاكرة (Memory)
- **التجميع:** فوري (اختبار سريع)
- **الاحتفاظ:** 1 يوم (بيانات مؤقتة)
- **التسجيل:** شامل للتتبع
- **الحد الأدنى للخوادم:** 0

---

## 📈 **المراقبة والتحليلات**

### **📊 المقاييس المهمة:**
- **معدل الاستجابة** - يجب أن يكون أقل من 100ms
- **معدل النجاح** - يجب أن يكون أعلى من 99.9%
- **استخدام الذاكرة** - يجب ألا يتجاوز 80%
- **استخدام Redis** - مراقبة الاتصالات والذاكرة
- **معدل التجميع** - عدد الإحصائيات المعالجة/ثانية
- **دقة البيانات** - التحقق من صحة الحسابات

### **🚨 التنبيهات:**
- **فشل في تجميع البيانات** - تنبيه فوري
- **تأخير في التحديث** - تنبيه خلال 10 دقائق
- **استخدام مفرط للذاكرة** - تنبيه فوري
- **انقطاع اتصال Redis** - تنبيه فوري
- **بيانات غير متسقة** - تنبيه يومي

---

## 🚀 **خطوات التطوير المطلوبة**

### **🎯 المرحلة الأولى - الأساسيات:**
1. ✅ إعداد البنية الأساسية
2. ✅ إنشاء نماذج البيانات
3. ✅ تطبيق واجهات برمجة التطبيقات
4. ⏳ ربط Redis وتطبيق العدادات
5. ⏳ تطبيق نظام التجميع الأساسي

### **🎯 المرحلة الثانية - التحليلات:**
1. ⏳ تطبيق تحليل الاتجاهات
2. ⏳ إضافة المقاييس المخصصة
3. ⏳ تطبيق التقارير التلقائية
4. ⏳ إضافة البيانات الفورية
5. ⏳ تطبيق نظام التنبيهات

### **🎯 المرحلة الثالثة - التكامل:**
1. ⏳ ربط جميع الخدمات المرسلة
2. ⏳ تطبيق لوحات التحكم
3. ⏳ اختبار الأداء والدقة
4. ⏳ تحسين الاستعلامات
5. ⏳ نشر بيئة الإنتاج

---

## 📚 **الموارد والمراجع**

### **📖 الوثائق المرجعية:**
- [مستودع المخزن - مواصفات الخدمات](../naebak-almakhzan/04-code-examples/03-services-specifications.md)
- [مستودع المخزن - البيانات الأولية](../naebak-almakhzan/02-data-models/04-initial-data.md)
- [مستودع المخزن - البنية التحتية](../naebak-almakhzan/07-infrastructure/01-deployment-infrastructure.md)

### **🔧 أدوات التطوير:**
- **Flask 2.3** - إطار العمل الأساسي
- **Redis 6.2** - قاعدة البيانات والتخزين المؤقت
- **NumPy 1.25.2** - العمليات الحسابية
- **Pandas 2.1.3** - تحليل البيانات
- **Google Cloud Memorystore** - Redis مُدار

---

**📝 ملاحظة:** هذا الملف هو الدليل الشامل لخدمة الإحصائيات. يجب مراجعته وتحديثه مع كل تطوير جديد في الخدمة.
